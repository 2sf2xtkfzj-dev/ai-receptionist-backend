// ============================================
// AI Receptionist SaaS - Prisma Schema
// Multi-tenant design with tenant_id enforcement
// ============================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// TENANT MODELS
// ============================================

model Tenant {
  id        String   @id @default(uuid())
  name      String
  slug      String   @unique
  status    TenantStatus @default(ACTIVE)
  settings  Json?    @default("{}")
  
  // Provider credentials (encrypted at rest in production)
  twilioConfig    Json?
  vapiConfig      Json?
  n8nConfig       Json?
  
  // Webhook configuration
  outboundWebhookUrl    String?
  outboundWebhookSecret String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  users         User[]
  calls         Call[]
  webhookEvents WebhookEvent[]
  webhookLogs   WebhookLog[]

  @@index([slug])
  @@index([status])
  @@map("tenants")
}

enum TenantStatus {
  ACTIVE
  SUSPENDED
  TRIAL
  CANCELLED
}

// ============================================
// USER MODELS (JWT Auth)
// ============================================

model User {
  id        String   @id @default(uuid())
  tenantId  String   @map("tenant_id")
  email     String
  passwordHash String @map("password_hash")
  role      UserRole @default(OWNER)
  
  // Profile
  firstName String?  @map("first_name")
  lastName  String?  @map("last_name")
  
  // Security
  lastLoginAt DateTime? @map("last_login_at")
  failedLoginAttempts Int @default(0) @map("failed_login_attempts")
  lockedUntil DateTime? @map("locked_until")
  
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, email])
  @@index([tenantId])
  @@index([email])
  @@map("users")
}

enum UserRole {
  OWNER
  ADMIN
}

// ============================================
// CALL MODELS (Core Business Entity)
// ============================================

model Call {
  id        String   @id @default(uuid())
  tenantId  String   @map("tenant_id")
  
  // External IDs (idempotency keys)
  externalCallId String? @map("external_call_id")
  provider       Provider
  
  // Call metadata
  direction      CallDirection
  fromNumber     String       @map("from_number")
  toNumber       String       @map("to_number")
  
  // AI handling
  aiHandled      Boolean      @default(false) @map("ai_handled")
  aiAgentId      String?      @map("ai_agent_id")
  
  // Outcome tracking (for monetization + dashboard)
  status         CallStatus   @default(PENDING)
  outcomeType    OutcomeType? @map("outcome_type")
  
  // Transcript (UTF-8, accents OK for Qu√©bec French)
  transcript     String?      @db.Text
  transcriptJson Json?        @map("transcript_json")
  
  // Recording
  recordingUrl   String?      @map("recording_url")
  recordingDuration Int?      @map("recording_duration")
  
  // Timestamps
  startedAt      DateTime     @map("started_at")
  answeredAt     DateTime?    @map("answered_at")
  endedAt        DateTime?    @map("ended_at")
  durationSeconds Int?        @map("duration_seconds")
  
  // Cost tracking (for monetization)
  providerCostCents   Int?    @map("provider_cost_cents")
  billedMinutes       Int?    @map("billed_minutes")
  
  // Customer info (for CRM integration)
  customerName        String? @map("customer_name")
  customerEmail       String? @map("customer_email")
  customerNotes       String? @map("customer_notes")
  
  // Metadata
  rawPayload          Json    @map("raw_payload")
  
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  events WebhookEvent[]

  @@unique([tenantId, externalCallId, provider])
  @@index([tenantId])
  @@index([tenantId, startedAt])
  @@index([tenantId, status])
  @@index([tenantId, outcomeType])
  @@index([tenantId, aiHandled])
  @@index([externalCallId])
  @@index([startedAt])
  @@map("calls")
}

enum Provider {
  TWILIO
  VAPI
}

enum CallDirection {
  INBOUND
  OUTBOUND
}

enum CallStatus {
  PENDING
  RINGING
  IN_PROGRESS
  COMPLETED
  FAILED
  NO_ANSWER
  BUSY
  CANCELLED
}

enum OutcomeType {
  BOOKED      // Appointment booked
  MISSED      // Call missed, no voicemail
  TRANSFERRED // Transferred to human
  VOICEMAIL   // Left voicemail
  SPAM        // Detected as spam
  INFO        // Information provided
  CALLBACK_REQUESTED // Customer requested callback
}

// ============================================
// WEBHOOK EVENTS (Internal Event Store)
// ============================================

model WebhookEvent {
  id        String   @id @default(uuid())
  tenantId  String   @map("tenant_id")
  
  // Event metadata
  eventId        String      @unique @map("event_id")
  eventType      String      @map("event_type")
  source         EventSource @map("source")
  
  // Payload (normalized internal schema)
  payload        Json
  
  // Processing state
  status         EventStatus @default(PENDING)
  processedAt    DateTime?   @map("processed_at")
  errorMessage   String?     @map("error_message")
  retryCount     Int         @default(0) @map("retry_count")
  
  // Idempotency
  idempotencyKey String?     @map("idempotency_key")
  
  // Relations
  callId         String?     @map("call_id")
  call           Call?       @relation(fields: [callId], references: [id])
  tenant         Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  // Delivery tracking
  deliveries     WebhookLog[]
  
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([tenantId])
  @@index([tenantId, eventType])
  @@index([tenantId, status])
  @@index([eventId])
  @@index([idempotencyKey])
  @@index([createdAt])
  @@map("webhook_events")
}

enum EventSource {
  TWILIO
  VAPI
  INTERNAL
  N8N
}

enum EventStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  RETRYING
  DEAD_LETTER
}

// ============================================
// WEBHOOK LOGS (Outbound Delivery Tracking)
// ============================================

model WebhookLog {
  id        String   @id @default(uuid())
  tenantId  String   @map("tenant_id")
  
  // Relations
  eventId   String   @map("event_id")
  event     WebhookEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)
  
  // Delivery details
  destinationUrl String    @map("destination_url")
  method         String    @default("POST")
  
  // Request/Response
  requestHeaders Json?     @map("request_headers")
  requestBody    Json?     @map("request_body")
  responseStatus Int?      @map("response_status")
  responseBody   String?   @map("response_body")
  responseTimeMs Int?      @map("response_time_ms")
  
  // Security
  signature      String?   @map("signature")
  
  // Status
  status         DeliveryStatus @default(PENDING)
  errorMessage   String?        @map("error_message")
  
  // Retry tracking
  attemptNumber  Int            @default(1) @map("attempt_number")
  nextRetryAt    DateTime?      @map("next_retry_at")
  
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([tenantId, eventId])
  @@index([tenantId, status])
  @@index([eventId])
  @@index([status])
  @@index([nextRetryAt])
  @@index([createdAt])
  @@map("webhook_logs")
}

enum DeliveryStatus {
  PENDING
  DELIVERED
  FAILED
  RETRYING
  DEAD_LETTER
}

// ============================================
// IDEMPOTENCY KEYS (Duplicate Prevention)
// ============================================

model IdempotencyKey {
  id        String   @id @default(uuid())
  key       String   @unique
  tenantId  String   @map("tenant_id")
  
  // What was processed
  resourceType String @map("resource_type")
  resourceId   String @map("resource_id")
  
  // TTL handling
  expiresAt DateTime @map("expires_at")
  
  createdAt DateTime @default(now()) @map("created_at")

  @@index([key])
  @@index([tenantId])
  @@index([expiresAt])
  @@map("idempotency_keys")
}

// ============================================
// METRICS AGGREGATION (Daily Rollups)
// ============================================

model DailyMetrics {
  id        String   @id @default(uuid())
  tenantId  String   @map("tenant_id")
  date      DateTime @db.Date
  
  // Call counts
  totalCalls        Int @default(0) @map("total_calls")
  inboundCalls      Int @default(0) @map("inbound_calls")
  outboundCalls     Int @default(0) @map("outbound_calls")
  aiHandledCalls    Int @default(0) @map("ai_handled_calls")
  
  // Outcomes
  bookedCalls       Int @default(0) @map("booked_calls")
  missedCalls       Int @default(0) @map("missed_calls")
  transferredCalls  Int @default(0) @map("transferred_calls")
  voicemailCalls    Int @default(0) @map("voicemail_calls")
  
  // Duration
  totalDurationSeconds Int @default(0) @map("total_duration_seconds")
  avgDurationSeconds   Float? @map("avg_duration_seconds")
  
  // Costs
  totalCostCents    Int @default(0) @map("total_cost_cents")
  
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([tenantId, date])
  @@index([tenantId])
  @@index([tenantId, date])
  @@map("daily_metrics")
}
